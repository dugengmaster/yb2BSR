
### LINE 登入技術文件

#### 目錄
1. [簡介](#簡介)
2. [環境設定](#環境設定)
3. [程式碼詳解](#程式碼詳解)
4. [錯誤處理](#錯誤處理)
5. [常見問題](#常見問題)

---

### 簡介
本文件介紹如何在現有系統中實現 LINE 登入功能。此功能包括從 LINE 獲取授權碼，使用授權碼交換訪問令牌，並使用訪問令牌獲取用戶資料，最後根據用戶資料進行用戶身份驗證及登錄。

### 環境設定
1. **設定檔案**：
    - 確保您的設定檔案包含以下配置：
    ```python
    LINE_CLIENT_ID = '您的LINE_CLIENT_ID'
    LINE_CLIENT_SECRET = '您的LINE_CLIENT_SECRET'
    ```

### 程式碼詳解
以下是實現 LINE 登入功能的兩個主要視圖函數及其說明：

#### `custom_line_login` 視圖函數

1. 檢查 `code` 和 `state` 參數是否存在於請求中。
2. 校驗 `state` 參數以防止 CSRF 攻擊。
3. 使用 `code` 參數獲取訪問令牌。
4. 使用訪問令牌從 LINE API 獲取用戶資料。
5. 根據 LINE 用戶 ID 驗證用戶是否已存在於系統中，如果不存在，則創建新用戶。
6. 登錄用戶並重定向至首頁。

#### `line_login_callback` 視圖函數

1. 獲取 `state` 和 `code` 參數。
2. 校驗 `state` 參數是否與會話中的 `line_login_state` 匹配。
3. 使用 `code` 獲取訪問令牌。
4. 使用訪問令牌從 LINE API 獲取用戶信息。
5. 根據 LINE 用戶 ID 創建或獲取用戶。
6. 如果是新用戶，顯示註冊模態；如果是已存在用戶，直接登錄。
7. 返回相應的響應或重定向。

### 錯誤處理
1. 如果 `state` 參數不匹配，返回 `HttpResponseBadRequest`。
2. 如果未能獲取訪問令牌，記錄錯誤並返回相應的錯誤信息。
3. 如果在用戶驗證或登錄過程中出現錯誤，記錄錯誤並返回相應的錯誤信息。

### 常見問題
1. **如何確保 `state` 參數的安全性？**
   - 使用隨機生成的 `state` 並將其存儲在會話中，以防止 CSRF 攻擊。
   
2. **如果 LINE API 返回錯誤，應如何處理？**
   - 應該記錄錯誤詳細信息並返回相應的錯誤響應，通知用戶重試或聯繫管理員。

3. **如何在現有用戶資料庫中查找用戶？**
   - 根據 LINE 用戶 ID 查找用戶，如果不存在則創建新用戶。

